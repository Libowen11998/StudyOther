### 消息中间件是什么：

- 利用可靠地消息传递机制进行系统和系统之间的直接通讯。
- 通过提供消息传递和消息的排队机制，他可以在分布式系统环境之下扩展进程之间的通讯。

### 消息中间件应用场景：

- 跨系统的数据传递
- 高并发的流量削峰
- 数据的分发和异步处理
- 大数据分析和传递
- 分布式事务

例如：当你有一个数据进行迁移，或者请求并发过多的时候，比如你有10W的并发请求下订单，我们可以在这些订单入库之前，把订单请求堆积到消息队列中，让他文件可靠的入库的执行。

### 常见的中间件

- ActiveMQ、RabbitMQ、Kafka、RocketMQ等

### 消息中间件的本质和设计

它是一种接受数据，接受请求，存储数据，发送数据等功能的技术服务。

- MQ消息队列：负责数据的传接受，存储和传递，所以性能普遍优于普通服务和技术



### 消息中间件的核心组成部分

- 消息的协议
- 消息的持久化机制
- 消息的分发策略
- 消息的高可用，高可靠
- 消息的容错机制



### 一，消息的协议（是在TCP/IP协议基础上构建的一种约定俗成的规范和机制，主要目的就是让客户端（应用程序java，go）进行沟通和通信，并必须具有持久性，高可用，高可靠的特点）

常见的消息中间价协议有：OpenWire、AMQP、MQTT、Kafak、OpenMessage协议

#### AMQP协议(Erlang语言开发)特性：（支持的中间件：RabbitMQ，ActiveMQ）

- 分布式事务支持
- 消息的持久性支持
- 高性能和高可靠的消息处理优势

#### MQTT协议特性：（支持的中间件：RabbitMQ，ActiveMQ）

- 轻量
- 结构简单
- 传输快，不支持事务
- 没有持久化设计

应用场景

- 使用于计算能力有限
- 低带宽
- 网络不稳定的场景

#### OpenMessage协议特性：（支持的中间件：RocketMQ）

- 结构简单
- 解析速度快
- 支持事务和持久化设计

#### Kafka协议（基于TCP/IP的二进制协议）特性：（支持的中间件：Kafka）

- 结构简单
- 解析速度快
- 不支持事务
- 有持久化设计





### 二，消息的持久化

简单来说就是将数据存入磁盘，而不是存在内存中随服务器重启而消失，使数据可以永久保存

|          | ActiveMQ | RabbitMQ | Kafka | RocketMQ |
| :------- | -------- | -------- | ----- | -------- |
| 文件存储 | 支持     | 支持     | 支持  | 支持     |
| 数据库   | 支持     | /        | /     | /        |

<img src="https://cdn.jsdelivr.net/gh/kongbaizz/myimages/images3/image-20210420162945818.png" alt="image-20210420162945818" style="zoom: 80%;" />



### 三，消息的分发策略

MQ消息队列有如下几个角色

1.生产者

2.存储消息

3.消费者

生产者生成消息后，MQ进行存储，消费者是如何获取到消息的呢？一般获取数据的方式无外乎推（push）或者拉（pull），

典型的git就有推拉机制，我们发送的http请求就是一种典型的拉去数据库数据返回的过程

而消息MQ是一种推送的过程，而这些推送会适用到很多业务场景，也有很多对应的推机制策略。

#### 消息分发策略和机制对比

|          | ActiveMQ | RabbitMQ | Kafka | RocketMQ |
| -------- | -------- | -------- | ----- | -------- |
| 发布订阅 | 支持     | 支持     | 支持  | 支持     |
| 轮询发布 | 支持     | 支持     | 支持  | /        |
| 公平分发 | /        | 支持     | 支持  | /        |
| 重发     | 支持     | 支持     | /     | 支持     |
| 消息拉取 | /支持    | 支持     | 支持  | 支持     |

#### 适用场景一

<img src="https://cdn.jsdelivr.net/gh/kongbaizz/myimages/images3/image-20210420163733232.png" alt="image-20210420163733232" style="zoom:80%;" />

#### 适用场景二

![image-20210420164144503](https://cdn.jsdelivr.net/gh/kongbaizz/myimages/images3/20210423133923.png)



### 四，消息的高可用，高可靠

**高可用**：值产品在规定的条件和规定的时刻或者时间内可执行规定功能状态的能力。

当业务增加的时候，请求也过大，一台消息中间件服务器的会触及硬件（cpu，内存，磁盘）的极限，

一台消息服务器已经无法满足业务需求，所以消息中间件必须支持集群部署。来达到高可用的目的。

要么消息共享，要么消息同步，要么元数据共享

**高可靠**：指系统可以无故障地持续运行，比如一个系统崩溃，报错，异常等等并不影响线上的业务正常运行，出错几率较低

在高并发业务场景中，如果不能保证系统的高可靠，那造成的损失和隐患是非常严重的

如何保证中间件消息的可靠性呢？可以从两个方面考虑

- 消息的传输：通过协议来保证系统间数据解析的正确性
- 消息的存储可靠：通过持久化来保证消息的可靠性



### 五，消息的容错机制

